# Руководство по чатам в системе недвижимости

## Обзор

Система чатов позволяет клиентам и агентам общаться по конкретным объектам недвижимости. Каждый чат привязан к определенному объекту и включает агента этого объекта и клиента.

## Функциональность

### Для клиентов:
1. **Создание чата**: На странице объекта недвижимости клиент может нажать кнопку "Начать чат с агентом"
2. **Отправка сообщений**: Клиент может отправлять сообщения агенту
3. **Просмотр истории**: Все сообщения сохраняются и отображаются в чате

### Для агентов:
1. **Просмотр чатов**: Агент видит все чаты по своим объектам
2. **Ответы клиентам**: Агент может отвечать на сообщения клиентов
3. **Уведомления**: Система показывает количество непрочитанных сообщений

## Интерфейс

### PropertyCard (карточка объекта)
- Кнопка чата с индикатором непрочитанных сообщений
- Зеленая кнопка = активный чат
- Красный бейдж = непрочитанные сообщения

### PropertyDetailsPage (страница объекта)
- Полноценный чат с историей сообщений
- Кнопка "Начать чат" для клиентов
- Автоматическое создание чата при первом сообщении

### ChatsPage (страница чатов)
- Список всех активных чатов
- Фильтрация по объектам
- Поиск по сообщениям

### HeaderChatDropdown (выпадающее меню)
- Быстрый доступ к последним чатам
- Индикатор непрочитанных сообщений
- Переход к полной странице чатов

## Логика работы

### Создание чата:
1. Клиент нажимает "Начать чат" на объекте
2. Система создает чат между клиентом и агентом объекта
3. Чат привязывается к конкретному объекту

### Отправка сообщений:
1. Только участники чата могут отправлять сообщения
2. Агент объекта может писать в чат даже если не является участником (после первого сообщения от клиента)
3. Сообщения отправляются через WebSocket в реальном времени

### Статусы сообщений:
- `sent` - отправлено
- `delivered` - доставлено
- `read` - прочитано

## Техническая реализация

### Backend:
- `ChatService` - основная логика чатов
- `ChatGateway` - WebSocket для реального времени
- `Conversation` и `Message` - сущности базы данных

### Frontend:
- `ChatContext` - управление состоянием чатов
- `PropertyCard` - кнопка чата на карточке объекта
- `PropertyDetailsPage` - полноценный чат
- `ChatsPage` - список всех чатов

## Безопасность

- Только участники чата могут видеть сообщения
- Агент объекта может видеть чат, но не может писать первым
- Все сообщения сохраняются в базе данных
- WebSocket соединения защищены JWT токенами

## Уведомления

- Индикатор непрочитанных сообщений в навигации
- Бейджи на кнопках чатов
- Статистика чатов на странице объектов
- Автоматическое обновление статусов сообщений 